<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kali Linux Terminal - Caio Duque</title>
  <style>
    body {
      margin: 0;
      overflow: hidden; /* Prevent scrolling on the terminal screen */
      font-family: 'monospace', 'Courier New', Courier;
      background-color: #000; /* Fundo preto */
    }

    #kaliTerminalScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      background-image: url('assets/images/kali_wallpaper.png');
      background-size: cover;
      background-position: center;
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 2vh;
    }

    .terminal-window {
      background-color: rgba(0, 0, 0, 0.85);
      border: 1px solid #333;
      border-radius: 8px;
      width: 90%;
      max-width: 900px;
      height: 85vh;
      display: flex;
      flex-direction: column;
      font-family: 'monospace', 'Courier New', Courier;
      font-size: 1rem;
      color: #eee;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
    }

    .terminal-header {
      background-color: #333;
      padding: 8px;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #ccc;
      font-size: 0.85rem;
      flex-shrink: 0;
    }

    .terminal-header-buttons span {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-left: 5px;
      cursor: pointer;
    }
    .terminal-header-buttons .red { background-color: #ff5f56; }
    .terminal-header-buttons .yellow { background-color: #ffbd2e; }
    .terminal-header-buttons .green { background-color: #27c93f; }

    .terminal-output {
      flex-grow: 1;
      padding: 15px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
      -webkit-overflow-scrolling: touch;
    }

    .terminal-input-line {
      display: flex;
      padding: 10px 15px;
      border-top: 1px solid #333;
      align-items: center;
      flex-shrink: 0;
    }

    .terminal-prompt {
      margin-right: 5px;
      flex-shrink: 0;
    }

    .terminal-input {
      background: none;
      border: none;
      color: #eee;
      outline: none;
      flex-grow: 1;
      caret-color: #00ff00;
    }

    /* Cores para os ASCII-arts e outputs */
    .ascii-blue { color: #5c64f4; }
    .ascii-purple { color: #a993ff; }
    .prompt-user { color: #00ff00; } /* root user */
    .prompt-host { color: #eee; }
    .prompt-path { color: #8be9fd; } /* cyan for path */
    .prompt-symbol { color: #00ff00; }
    .command-output-dir { color: #3498db; }
    .command-output-file { color: #ffffff; }
    .success-message { color: #50fa7b; }
    .warning-message { color: #f1fa8c; }
    .error-message { color: #ff5555; }
    .info-message { color: #8be9fd; }

  </style>
</head>
<body>
  <div id="kaliTerminalScreen">
    <div class="terminal-window">
      <div class="terminal-header">
        <span id="currentPathHeader"></span>
        <div class="terminal-header-buttons">
          <span class="red" id="closeTerminalBtn"></span>
          <span class="yellow"></span>
          <span class="green"></span>
        </div>
      </div>

      <div class="terminal-output" id="terminalOutput">
        <!-- O conteúdo inicial será injetado pelo JavaScript -->
      </div>
      <div class="terminal-input-line">
        <span id="terminalPrompt" class="terminal-prompt"></span>
        <input type="text" id="terminalInput" class="terminal-input" autofocus autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- ELEMENTOS DO DOM ---
      const terminalOutput = document.getElementById('terminalOutput');
      const terminalInput = document.getElementById('terminalInput');
      const terminalPrompt = document.getElementById('terminalPrompt');
      const currentPathHeader = document.getElementById('currentPathHeader');
      const closeTerminalBtn = document.getElementById('closeTerminalBtn');

      // --- ESTADO DO TERMINAL ---
      let currentUser = 'root';
      let currentDirectory = '/root';
      const userPasswords = { 'dev': 'P@ssw0rdDev!' };
      let commandHistory = [];
      let historyIndex = -1;
      let isPasswordPrompt = false;

      // --- SISTEMA DE ARQUIVOS SIMULADO (com trilha do CTF) ---
      const fileSystem = {
        '/': {
          type: 'directory',
          children: {
            'bin': { type: 'directory', children: {} },
            'etc': { type: 'directory', children: { 'passwd': { type: 'file' }, 'shadow': { type: 'file', content: 'root:$6$...:18650::::::\ndev:!!:18650::::::' } } },
            'home': {
              type: 'directory',
              children: {
                'dev': {
                  type: 'directory',
                  children: {
                    'flag.txt': {
                      type: 'file',
                      content: 'Parabéns, você encontrou a flag!\n\nflag{m3_ch4m3_n0_d!Sc0rD_zcaioduque_e_3nviE_est4_fl4g}\n\nObrigado por jogar! Isso demonstra sua curiosidade e habilidade em seguir pistas, características essenciais de um bom profissional de tecnologia e segurança.'
                    }
                  }
                }
              }
            },
            'opt': { type: 'directory', children: {} },
            'root': {
              type: 'directory',
              children: {
                'Desktop': { type: 'directory', children: {} },
                'Documents': { type: 'directory', children: { 'notes.txt': { type: 'file', content: 'Credenciais de backup: admin:password123' } } },
                'Downloads': { type: 'directory', children: {} }
              }
            },
            'var': {
              type: 'directory',
              children: {
                'log': {
                  type: 'directory',
                  children: {
                    'apache': {
                      type: 'directory',
                      children: {
                        'access.log': { type: 'file', content: '127.0.0.1 - - [28/Jun/2025:10:00:00 -0300] "GET /index.html HTTP/1.1" 200 1234\n10.10.10.5 - - [28/Jun/2025:10:05:12 -0300] "GET /backup/config.php.bak HTTP/1.1" 200 512' }
                      }
                    },
                    'auth.log': { type: 'file', content: 'Jun 28 10:05:01 kali sshd[1234]: Failed password for invalid user from 10.10.10.5 port 22 ssh2' }
                  }
                }
              }
            },
            'www': {
                type: 'directory',
                children: {
                    'html': {
                        type: 'directory',
                        children: {
                            'index.html': { type: 'file' },
                            'backup': {
                                type: 'directory',
                                children: {
                                    'config.php.bak': {
                                        type: 'file',
                                        content: '<?php\n// ARQUIVO DE CONFIGURAÇÃO DE BACKUP\n\n$db_host = "localhost";\n$db_user = "admin_db";\n$db_pass = "S3nh@F0rt3!";\n\n// TODO: Remover credenciais hardcoded do usuário de desenvolvimento!\n// user: \'dev\', pass: \'P@ssw0rdDev!\'\n\n?>'
                                    }
                                }
                            }
                        }
                    }
                }
            }
          }
        }
      };

      // --- FUNÇÕES AUXILIARES ---
      const printToTerminal = (text, className = '') => {
        const line = document.createElement('div');
        if (className) {
            line.classList.add(className);
        }
        line.innerHTML = text;
        terminalOutput.appendChild(line);
        terminalOutput.scrollTop = terminalOutput.scrollHeight;
      };
      
      // FUNÇÃO DE RESOLUÇÃO DE CAMINHO UNIFICADA E CORRIGIDA
      const resolveNodeFromPath = (path) => {
        const pathParts = path.split('/').filter(p => p && p !== '.');
        let startingNode = fileSystem['/'];
        let resolvedParts = [];

        if (!path.startsWith('/')) {
            resolvedParts = currentDirectory.split('/').filter(p => p);
        }

        for (const part of pathParts) {
            if (part === '..') {
                resolvedParts.pop();
            } else {
                resolvedParts.push(part);
            }
        }
        
        let currentNode = startingNode;
        for (const part of resolvedParts) {
            if (currentNode && currentNode.type === 'directory' && currentNode.children && currentNode.children[part]) {
                currentNode = currentNode.children[part];
            } else {
                return null;
            }
        }
        
        const finalPath = '/' + resolvedParts.join('/');
        return { node: currentNode, path: finalPath };
      };

      const updatePrompt = () => {
        const pathForPrompt = currentDirectory.replace(`/home/${currentUser}`, '~').replace('/root', '~');
        const userColor = currentUser === 'root' ? '#ff5555' : '#50fa7b';
        terminalPrompt.innerHTML = `<span style="color:${userColor};">${currentUser}@kali</span><span class="prompt-host">:</span><span class="prompt-path">${pathForPrompt}</span><span class="prompt-symbol"># </span>`;
        currentPathHeader.textContent = `${currentUser}:${pathForPrompt}`;
      };

      // --- PROCESSADOR DE COMANDOS ---
      const processCommand = (command) => {
        if (isPasswordPrompt) return;

        printToTerminal(`${terminalPrompt.innerHTML}${command}`);
        if (command.trim() === '') return;
        commandHistory.unshift(command);
        historyIndex = -1;

        const parts = command.trim().split(' ');
        const cmd = parts[0];
        const args = parts.slice(1);

        switch (cmd) {
          case 'help':
            printToTerminal('Comandos disponíveis:');
            printToTerminal(`  <span class="info-message">ls</span>         - Lista o conteúdo do diretório.`);
            printToTerminal(`  <span class="info-message">cd &lt;dir&gt;</span>   - Muda para o diretório <dir>.`);
            printToTerminal(`  <span class="info-message">cat &lt;file&gt;</span> - Exibe o conteúdo do arquivo <file>.`);
            printToTerminal(`  <span class="info-message">whoami</span>     - Mostra o usuário atual.`);
            printToTerminal(`  <span class="info-message">su &lt;user&gt;</span>  - Troca para o usuário <user>.`);
            printToTerminal(`  <span class="info-message">clear</span>      - Limpa a tela do terminal.`);
            printToTerminal(`  <span class="info-message">exit</span>       - Sai do modo Cybersecurity.`);
            break;
            
          case 'ls':
            const dirToListResult = resolveNodeFromPath(args[0] || currentDirectory);
            if (dirToListResult && dirToListResult.node.type === 'directory') {
                let output = Object.keys(dirToListResult.node.children).map(key => {
                    const item = dirToListResult.node.children[key];
                    return `<span class="${item.type === 'directory' ? 'command-output-dir' : 'command-output-file'}">${key}</span>`;
                }).join('  ');
                printToTerminal(output);
            } else {
                 printToTerminal(`ls: não foi possível acessar '${args[0] || '.'}': Arquivo ou diretório não encontrado`, 'error-message');
            }
            break;
          
          case 'cd':
            const targetPath = args[0];
            if (!targetPath) break;
            const dirResult = resolveNodeFromPath(targetPath);
            if (dirResult && dirResult.node.type === 'directory') {
                currentDirectory = dirResult.path;
            } else {
                printToTerminal(`bash: cd: ${targetPath}: Não é um diretório ou não foi encontrado`, 'error-message');
            }
            break;

          case 'cat':
            const pathToFile = args[0];
            if(!pathToFile) break;
            const fileResult = resolveNodeFromPath(pathToFile);
            if(fileResult && fileResult.node.type === 'file'){
                printToTerminal(fileResult.node.content.replace(/</g, "&lt;").replace(/>/g, "&gt;") || '');
            } else {
                printToTerminal(`cat: ${pathToFile}: Arquivo ou diretório não encontrado`, 'error-message');
            }
            break;

          case 'whoami':
            printToTerminal(currentUser);
            break;

          case 'su':
            const targetUser = args[0];
            if (!targetUser) {
                printToTerminal("su: usuário não especificado", "error-message");
                break;
            }
            if (targetUser === currentUser) {
                printToTerminal("Você já é este usuário.");
                break;
            }
            if (userPasswords[targetUser]) {
                isPasswordPrompt = true;
                terminalInput.type = 'password';
                printToTerminal(`Senha para ${targetUser}:`);
                
                const passwordHandler = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const password = terminalInput.value;
                        terminalInput.value = '';
                        terminalInput.type = 'text';
                        isPasswordPrompt = false;

                        if (password === userPasswords[targetUser]) {
                            currentUser = targetUser;
                            currentDirectory = `/home/${currentUser}`;
                            printToTerminal("Login bem-sucedido!", "success-message");
                        } else {
                            printToTerminal("su: Falha na autenticação", "error-message");
                        }
                        terminalInput.removeEventListener('keydown', passwordHandler);
                        terminalInput.addEventListener('keydown', commandHandler);
                        updatePrompt();
                    }
                };
                terminalInput.removeEventListener('keydown', commandHandler);
                terminalInput.addEventListener('keydown', passwordHandler);
            } else {
                printToTerminal(`su: Usuário '${targetUser}' não encontrado.`, "error-message");
            }
            break;

          case 'clear':
            terminalOutput.innerHTML = '';
            break;

          case 'exit':
            window.location.href = 'index.html';
            break;

          default:
            printToTerminal(`bash: ${cmd}: comando não encontrado`, 'error-message');
        }
        if (!isPasswordPrompt) updatePrompt();
      };

      // --- INICIALIZAÇÃO E EVENTOS ---
      const commandHandler = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            processCommand(terminalInput.value);
            terminalInput.value = '';
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (historyIndex < commandHistory.length - 1) {
                historyIndex++;
                terminalInput.value = commandHistory[historyIndex];
            }
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (historyIndex > 0) {
                historyIndex--;
                terminalInput.value = commandHistory[historyIndex];
            } else {
                historyIndex = -1;
                terminalInput.value = '';
            }
        }
      };

      const printWelcomeMessage = () => {
        const asciiBlue = `<span class="ascii-blue">
                    ..:^~!77777777!!!~^^:..                 
              .:^!77?77!~^:..:7????????????77!~^..          
            ~??7!^:.          7???????????????????7.        
        ^^   .                ?????????????????????:        
        ^?.                  .~!!777???????????????: ^      
      !.^?:       ...::^~~!777      ..^!7?????????7..7.     
  .  .~ :?^                  .:..        :7???????7. .~^?:  
  .J!~. :?!           .       !??7!^.      !??????!  ~!?:   
   .7~^ .77.          ..      ~??????!:     7?????~ ...!.~^ 
 ~7^!.^^.!?:          .~      ~????????~    ^?????: !Y?J?7. 
  ~!J7?: ^?~           !      ^?????????:   ^????7.:. .7    
..  !  :~:7?.          7:     ^?????????.   ~????: !5?^!~?7.
 7Y?7!Y5^ ^?7          7~     :???????!.   .????~   :~J!!~  
  .:~?:  ..!?~         77.    :????7~.    .7???! .J! .!     
     ~:.?Y. !?~        !?:    .7!^.     .~????~   ?5JJ~~~.  
  .7?7JYY~  .!?!.      ~?!...^:      .:!?????^ :~  ~!:!!.   
    ::.^^  ?^ ^??:     ^??????^  .:~7??????!.  ^5~:~.       
      ..~!!Y: .:!?!.   :~^:.. .7?????????7: ~7  !!?J?~.     
      ^77!^~  J! :7?!:         ????????!^7. 7Y^^.           
           .~!Y! .?~!?7^.      ?????7~. 7Y^.:!J?7~.         
         .~777^..^Y? .^7?!:    7?77~....^??!.               
              .^7?7.....^!7?!:::.         .::.              
              ...          .~7^ 
</span>`;

        const asciiPurple = `      <span class="ascii-purple">        
 █████╗  █████╗ ██████╗  █████╗██  ╔═██ ██████╗  █████╗
██   ██ ██   ██ ██╔══██╗██   ██ ██ ║██║██    ██ ██╔═══╝  
██╔══██╗██╔══██╗██████╔╝██╔══██╗██ ║██║██    ██ ██████╗    
███████║███████║██╔══██╗███████║██ ║██║██╔═══██╗ ╔══██║      
██╔══██║██╔══██║██║  ██║██╔══██║ ████╔╝ ██████╔╝█████╔╝
╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝ ╚═══╝  ╚═════╝ ╚════╝
</span> `;

        const motd = `
<pre>${asciiBlue}${asciiPurple}
                                                By: Caio Duque - v2025.3
<span class="success-message">Iniciando Desafio CTF (Capture The Flag).</span>
Bem-vindo, Agente. Sua missão, caso decida aceitá-la, é encontrar a flag secreta escondida neste sistema.

<span class="warning-message">PRIMEIRA PISTA:</span> Um novo servidor web foi configurado às pressas. Verifique os logs em <span class="prompt-path">/var/log</span> para qualquer atividade suspeita.

Use '<span class="info-message">help</span>' para ver os comandos disponíveis. Boa sorte.
</pre>`;
        terminalOutput.innerHTML = motd;
      };

      terminalInput.addEventListener('keydown', commandHandler);
      closeTerminalBtn.addEventListener('click', () => window.location.href = 'index.html');
      
      document.querySelector('.terminal-window').addEventListener('click', (e) => {
        if (e.target.id !== 'terminalInput') {
          terminalInput.focus();
        }
      });

      printWelcomeMessage();
      updatePrompt();
      terminalInput.focus();
    });
  </script>
</body>
</html>
